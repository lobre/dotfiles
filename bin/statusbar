#!/bin/sh

clock() {
    echo "%{A:firefox --new-tab https\://calendar.google.com/:}$(date '+%a %-e %b %-H:%M')%{A}"
}

groups() {
    current_group=$(xprop -root _NET_CURRENT_DESKTOP | awk '{print $3}')

    enabled_groups="$current_group"
    shown_groups=""

    for win in $(xwininfo -root -children | awk '$1 ~ /^0x/ {print $1}'); do
        window_group=$(xprop -id "$win" _NET_WM_DESKTOP 2>/dev/null | awk -F '=' '{print $2}' | sed 's/^ //')

        echo "$window_group" | grep -qE '^[0-9]$' || continue

        enabled_groups="$enabled_groups $window_group"

        if xwininfo -id "$win" | grep -q "Map State: IsViewable"; then
            shown_groups="$shown_groups $window_group"
        fi
    done

    # remove duplicates
    enabled_groups=$(echo "$enabled_groups" | tr ' ' '\n' | sort -nu | tr '\n' ' ')
    shown_groups=$(echo "$shown_groups" | tr ' ' '\n' | sort -nu | tr '\n' ' ')

    output=""

    for i in $enabled_groups; do
        group="$i"

        [ "$i" = "$current_group" ] && group="%{+u}${group}%{-u}"

        if echo "$shown_groups" | grep -qw "$i"; then
            group="%{F#FFD480}$group%{F-}"
        else
            group="%{F#808080}$group%{F-}"
        fi

        output="$output$group "
    done

    output=$(echo "$output" | sed 's/ *$//') # trim ending spaces

    echo "%{F#FFD480}(%{F-}$output%{F#FFD480})%{F-}"
}

battery() {
    # hide when not charging
    acpi -b | grep -q ': Not charging,' && return

    level=$(acpi -b | awk -F ', ' '{print $2}' | tr -d '%')

    if [ "$level" -lt 15 ]; then
        echo "%{F#FF695C}[$level%%]%{F-}"
    else
        echo "%{F#79A4A9}[$level%%]%{F-}"
    fi
}

restart() {
    lemonpid=$(pstree -p $$ | grep -oP 'lemonbar\(\K[0-9]+')
    echo "%{A:kill $lemonpid && exec "$0":}%{F#44FFFFFF}î©¶  %{F-}%{A}"
}

geometry() {
    set -- $(xrandr --query | awk '/ primary / {print $4}' | tr 'x+' ' ')
    x=$(( $3 + ($1 - 250) / 2 ))
    echo "250x25+$x+$4"
}

lemonbar="lemonbar -p -d -g $(geometry) -u 2 -U '#FFD480' -B '#77000000' -f 'PragmataPro Mono:size=9'"

(
    while true; do
        echo "%{c}$(groups) $(clock) $(battery) %{r}$(restart)"
        sleep 0.3
    done
) | eval "$lemonbar" | setsid "$SHELL"
