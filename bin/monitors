#!/bin/sh

layouts_dir="$HOME/.screenlayout"
mkdir -p "$layouts_dir"

set_dpi() {
    dpi="$1"
    cursor_size=$(( (24 * dpi + 48) / 96 ))

    xrandr --dpi "$dpi"
    echo "Xft.dpi: $dpi" | xrdb -merge
    echo "Xcursor.size: $cursor_size" | xrdb -merge
}

# generate unique fingerprint between the output
# and the physical monitor which is plugged to it
output_fingerprint() {
    output="$1"

    edid=$(xrandr --verbose | awk -v output="$output" '
        $1 == output && $2 == "connected" { in_block = 1 }

        in_block && /EDID:/ { capture = 1; next }

        capture {
            if ($0 ~ /^[ \t]+[0-9a-fA-F]{32}$/) {
                gsub(/[ \t]/, "", $0)
                edid = edid $0
            } else {
                print edid
                exit
            }
        }
    ')

    hash="000000"

    if [ -n "$edid" ]; then
        hash=$(printf "%s" "$edid" | md5sum | cut -c1-6)
    fi

    printf "%s-%s" "$output" "$hash"
}

ref=""

for output in $(xrandr | awk '$2 == "connected" { print $1 }' | sort); do
    ref="${ref}_$(output_fingerprint "$output")"
done

ref="${ref#_}"

layout="$layouts_dir/${ref}.sh"

if [ -f "$layout" ]; then
    . "$layout"
else
    echo "No layout file found. Create one at:"
    echo "$layout"
fi

# restore wallpaper
nitrogen --restore 2>/dev/null
