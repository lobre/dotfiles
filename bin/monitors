#!/bin/sh

layouts_dir="$HOME/.screenlayout"
mkdir -p "$layouts_dir"

hashed_edid() {
    output="$1"

    edid=$(xrandr --verbose | awk -v output="$output" '
        $1 == output && $2 == "connected" { in_block = 1 }

        in_block && /EDID:/ { capture = 1; next }

        capture {
            if ($0 ~ /^[ \t]+[0-9a-fA-F]{32}$/) {
                gsub(/[ \t]/, "", $0)
                edid = edid $0
            } else {
                print edid
                exit
            }
        }
    ')

    [ -z "$edid" ] && return

    printf "%s" "$edid" | md5sum | cut -c1-6
}

current_layout_ref() {
    outputs=$(xrandr | awk '$2 == "connected" { print $1 }' | sort)

    labels=""
    for output in $outputs; do
        id=$(hashed_edid "$output")
        labels="${labels}_${output}-${id}"
    done

    printf "%s\n" "${labels#_}"
}

layout_ref=$(current_layout_ref)

layout_filepath=$(find "$layouts_dir" -type f -name "*.sh" | awk -F/ -v ref="$layout_ref" '
    {
        file = $NF
        pattern = "^[^_]+_" ref "_[^_]+\\.sh$"
        if (file ~ pattern) {
            print $0
            exit
        }
    }
')

if [ -n "$layout_filepath" ]; then
    layout_filename="$(basename -- "$layout_filepath")"
    layout_name="${layout_filename%%_*}"
    layout_dpi="${layout_filename##*_}"
    layout_dpi="${layout_dpi%.sh}"

    xrandr --dpi "$layout_dpi"
    echo "Xft.dpi: $layout_dpi" | xrdb -merge

    . "$layout_filepath"
else
    echo "No layout file found, create one at:"
    echo "$layouts_dir/<name>_${layout_ref}_<dpi>.sh"
fi

nitrogen --restore 2>/dev/null
